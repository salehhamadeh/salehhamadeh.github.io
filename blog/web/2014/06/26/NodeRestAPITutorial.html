<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>How to build a scalable REST API using Node.JS and Express</title>
        <meta name="description" content="Saleh Hamadeh's official blog. I write about technology, programming, hacks, and my personal life." />
        <meta name="author" content="Saleh Hamadeh" />
        <meta name="keywords" content="Saleh Hamadeh, Blog, Technology, Programming" />

        <meta name="viewport" content="width=device-width">

        <!-- RSS -->
        <link rel="alternate" type="application/rss+xml" title="Saleh Hamadeh's Blog" href="http://www.shamadeh.com/blog/feed.xml">

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins and for endpage-box) -->
        <script src="https://code.jquery.com/jquery.js"></script>
        <!-- Twitter Bootstrap -->
        <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
        <!-- Font Awesome -->
        <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <!-- AddThis Smart Layers BEGIN -->
        <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-51fee1032ce6a513"></script>
        <script type="text/javascript">
          addthis.layers({
            'theme' : 'transparent',
            'share' : {
              'position' : 'left',
              'numPreferredServices' : 5
            }   
          });
        </script>
        <!-- AddThis Smart Layers END -->
        

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/stylesheets/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/stylesheets/style.css">

        <!-- Related article box code -->
        
          <link rel="stylesheet" href="/stylesheets/endpage-box.css">
          <script src="/js/jquery.endpage-box.min.js"></script>
          <script type="text/javascript">
            $(window).load( function() {
              $("#endpage-box").endpage_box({
                animation: "fade",
                from: "90%",
                to: "1000%",
              });
            });
          </script>
        
    </head>
    <body>
      <div id="wrap">
        <div class="navbar navbar-default navbar-static-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <div class="navbar-collapse collapse" id="navbar-main">
      <ul class="nav navbar-nav">
        <li>
          <a href="/index.html">About Me</a>
        </li>
        <li>
          <a href="/projects.html">Projects</a>
        </li>
        <li class="active">
          <a href="/blog.html">Blog</a>
        </li>
      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://www.facebook.com/salehhamadeh" target="_blank"><i class="fa fa-facebook fa-lg"></i><span class="sr-only">Facebook Profile</span></a></li>
        <li><a href="https://twitter.com/salehhamadeh" target="_blank"><i class="fa fa-twitter fa-lg"></i><span class="sr-only">Twitter Profile</span></a></li>
        <li><a href="https://github.com/salehhamadeh" target="_blank"><i class="fa fa-github fa-lg"></i><span class="sr-only">Github Profile</span></a></li>
        <li><a href="http://www.linkedin.com/pub/saleh-hamadeh/62/8b6/2a2" target="_blank"><i class="fa fa-linkedin fa-lg"></i><span class="sr-only">LinkedIn Profile</span></a></li>
      </ul>
    </div>
  </div>
</div>

        <div class="container">
          <div class="row">
            <h1>Saleh Hamadeh's Blog</h1>
            <div class="col-md-8 col-md-offset-1">
              <div class="post">
	<span class='date'>26 Jun 2014</span>
	<h1><a href=''>How to build a scalable REST API using Node.JS and Express</a></h1>
	<div class='body'><p>When I build an API, I like to have it as light-weight and scalable as possible. At the same time, I want to be able to easily add or remove features with the least amount of effort possible. Because <a href="http://nodejs.org/">Node.JS</a> and <a href="http://expressjs.com/">Express</a> give control over the inner workings of a web application, they are the perfect fit.</p>

<h2>What will we build?</h2>

<p>We will build a RESTful API for a library. A library has books, accounts, DVDs, and many more things. As I always do, I will approach the problem by building an API for books only, and then scaling it to include all the other library items.</p>

<h2>First Rollout: Build a Dumb Server</h2>

<p>Before we start writing code, we need to fetch the dependencies. Even though the only dependency is Express, I like to keep a package.json file in case I ever decide to add other dependencies in the future. So, the first thing we will do is create a file called package.json and put the following code in it:</p>

<div class="highlight"><pre><code class="json"><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;library-rest-api&quot;</span><span class="p">,</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;A simple library REST api&quot;</span><span class="p">,</span>
    <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;express&quot;</span><span class="p">:</span> <span class="s2">&quot;~3.1.0&quot;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>Now open up your terminal or command line and go to the project&#39;s directory. Type</p>

<div class="highlight"><pre><code class="sh">npm install</code></pre></div>

<p>to install Express. It will be installed in the node_modules directory.</p>

<p>Now that we have all the dependencies ready, let&#39;s create a simple server that will capture requests and respond with a Hello World.</p>

<div class="highlight"><pre><code class="js"><span class="c1">// Module dependencies.</span>
<span class="kd">var</span> <span class="nx">application_root</span> <span class="o">=</span> <span class="nx">__dirname</span><span class="p">,</span>
    <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="s1">&#39;express&#39;</span> <span class="p">);</span> <span class="c1">//Web framework</span>

<span class="c1">//Create server</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="c1">// Configure server</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//parses request body and populates request.body</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span> <span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">()</span> <span class="p">);</span>

    <span class="c1">//checks request.body for HTTP method overrides</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span> <span class="nx">express</span><span class="p">.</span><span class="nx">methodOverride</span><span class="p">()</span> <span class="p">);</span>

    <span class="c1">//perform route lookup based on url and HTTP method</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span> <span class="nx">app</span><span class="p">.</span><span class="nx">router</span> <span class="p">);</span>

    <span class="c1">//Show all errors in development</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span> <span class="nx">express</span><span class="p">.</span><span class="nx">errorHandler</span><span class="p">({</span> <span class="nx">dumpExceptions</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">showStack</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}));</span>
<span class="p">});</span>

<span class="c1">//Router</span>
<span class="c1">//Get a list of all books</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;/api/books&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">books</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Book 1&quot;</span><span class="p">,</span>
                <span class="nx">author</span><span class="o">:</span> <span class="s2">&quot;Author 1&quot;</span><span class="p">,</span>
                <span class="nx">releaseDate</span><span class="o">:</span> <span class="s2">&quot;01/01/2014&quot;</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Book 2&quot;</span><span class="p">,</span>
                <span class="nx">author</span><span class="o">:</span> <span class="s2">&quot;Author 2&quot;</span><span class="p">,</span>
                <span class="nx">releaseDate</span><span class="o">:</span> <span class="s2">&quot;02/02/2014&quot;</span>
            <span class="p">}</span>
        <span class="p">];</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">books</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">//Insert a new book</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span> <span class="s1">&#39;/api/books&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">book</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">title</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
        <span class="nx">author</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">,</span>
        <span class="nx">releaseDate</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">releaseDate</span>
    <span class="p">};</span>
    
    <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">book</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">//Get a single book by id</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;/api/books/:id&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">book</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Unique Book&quot;</span><span class="p">,</span>
        <span class="nx">author</span><span class="o">:</span> <span class="s2">&quot;Unique Author&quot;</span><span class="p">,</span>
        <span class="nx">releaseDate</span><span class="o">:</span> <span class="s2">&quot;03/03/2014&quot;</span>
    <span class="p">};</span>
    
    <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">book</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">//Update a book</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span> <span class="s1">&#39;/api/books/:id&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;Updated!&quot;</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">//Delete a book</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span> <span class="s1">&#39;/api/books/:id&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;Deleted&quot;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">//Start server</span>
<span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">4711</span><span class="p">;</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span> <span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s1">&#39;Express server listening on port %d in %s mode&#39;</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">env</span> <span class="p">);</span>
<span class="p">});</span></code></pre></div>

<p>Save the file and run</p>

<div class="highlight"><pre><code class="sh">node server.js</code></pre></div>

<p>to start the server. The server should response with the hardcoded data when you try to get a book and should echo back the data when you try to do another operation, such as inserting, deleting, or updating.</p>

<h2>From Dumb to RESTful</h2>

<p>Before we can use real data in our API, we must understand the two fundamental requirements for every API. These two fundamental requirements are communication and storage.</p>

<p>Communication refers to the way in which data is passed back-and-forth between the server and the clients. Since we are building a RESTful API, our communication protocol is <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a>, which we dealt with using Express.</p>

<p>Storage refers to the medium and format in which data is stored. For example, data can be stored on a database server, in a file, or in memory. To fulfill this requirement, I like to start by using MongoDB to store my data. To access the <a href="http://www.mongodb.org/">MongoDB</a> database from Node.JS, we will use an NPM package called <a href="http://mongoosejs.com/">Mongoose</a>.</p>

<h2>Setting up the Database</h2>

<p>Before you start using real data in your API, you need to install MongoDB or use a third-party service like MongoHQ. Please refer to the instructions on the MongoDB website to install MongoDB.</p>

<p>After you install MongoDB, create a database called library_database. Then, add a collection named &quot;books&quot; to the database. Run the database server (mongod), and you should be all set.</p>

<h2>Second Rollout: Use Real Data</h2>

<p>As always, before we start writing any code, we must have all the dependencies ready. The new dependency that we will introduce for this rollout is Mongoose. To install Mongoose, modify your package.json file to look as follows:</p>

<div class="highlight"><pre><code class="json"><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;library-rest-api&quot;</span><span class="p">,</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;A simple library REST api&quot;</span><span class="p">,</span>
    <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;express&quot;</span><span class="p">:</span> <span class="s2">&quot;~3.1.0&quot;</span><span class="p">,</span>
        <span class="nt">&quot;mongoose&quot;</span><span class="p">:</span> <span class="s2">&quot;~3.5.5&quot;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>and run</p>

<div class="highlight"><pre><code class="sh">npm install</code></pre></div>

<p>To use Mongoose from our Node.js application, we first need to require it. Change the module dependencies code block to</p>

<div class="highlight"><pre><code class="js"><span class="c1">// Module dependencies.</span>
<span class="kd">var</span> <span class="nx">application_root</span> <span class="o">=</span> <span class="nx">__dirname</span><span class="p">,</span>
    <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="s1">&#39;express&#39;</span> <span class="p">),</span>     <span class="c1">//Web framework</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="s1">&#39;path&#39;</span> <span class="p">),</span>           <span class="c1">//Utilities for dealing with file paths</span>
    <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="s1">&#39;mongoose&#39;</span> <span class="p">);</span>   <span class="c1">//Used for accessing a MongoDB database</span></code></pre></div>

<p>Then, we need to connect Mongoose to our database. We use the connect method to connect it to our local (or remote) database. Note that the url points to the database inside MongoDB (in this case it is library_database).</p>

<div class="highlight"><pre><code class="js"><span class="c1">//Connect to database</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span> <span class="s1">&#39;mongodb://localhost/library_database&#39;</span> <span class="p">);</span></code></pre></div>

<p>Mongoose provides two neat classes for dealing with data: Schema and model. Schema is used for data validation, and Model is used to send and receive data from the database. We will now create a Schema and a Model that adhere to our original data model.</p>

<div class="highlight"><pre><code class="js"><span class="c1">//Schema</span>
<span class="kd">var</span> <span class="nx">BookSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
    <span class="nx">title</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">author</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">releaseDate</span><span class="o">:</span> <span class="nb">Date</span>
<span class="p">});</span>
<span class="c1">//Model</span>
<span class="kd">var</span> <span class="nx">BookModel</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span> <span class="s1">&#39;Book&#39;</span><span class="p">,</span> <span class="nx">BookSchema</span> <span class="p">);</span></code></pre></div>

<p>Now we have everything ready to start responding to API requests. Since all of the request/response processing happens in the router, we will only change the router code it account for the persistent data. The new router should look as follows:</p>

<div class="highlight"><pre><code class="js"><span class="c1">//Router</span>
<span class="c1">//Get a list of all books</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;/api/books&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">BookModel</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">books</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span> <span class="nx">books</span> <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span> <span class="p">);</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
<span class="c1">//Insert a new book</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span> <span class="s1">&#39;/api/books&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BookModel</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
        <span class="nx">author</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">,</span>
        <span class="nx">releaseDate</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">releaseDate</span>
    <span class="p">});</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
    <span class="nx">book</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s1">&#39;created&#39;</span> <span class="p">);</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span> <span class="nx">book</span> <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span> <span class="p">);</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
<span class="c1">//Get a single book by id</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;/api/books/:id&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">BookModel</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span> <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">book</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span> <span class="nx">book</span> <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span> <span class="p">);</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
<span class="c1">//Update a book</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span> <span class="s1">&#39;/api/books/:id&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">BookModel</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span> <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">book</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">book</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
        <span class="nx">book</span><span class="p">.</span><span class="nx">author</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">;</span>
        <span class="nx">book</span><span class="p">.</span><span class="nx">releaseDate</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">releaseDate</span><span class="p">;</span>

        <span class="k">return</span> <span class="nx">book</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s1">&#39;book updated&#39;</span> <span class="p">);</span>
                <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span> <span class="nx">book</span> <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span> <span class="p">);</span>
                <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
<span class="c1">//Delete a book</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span> <span class="s1">&#39;/api/books/:id&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">BookModel</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span> <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">book</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">book</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s1">&#39;Book removed&#39;</span> <span class="p">);</span>
                <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span> <span class="s1">&#39;&#39;</span> <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span> <span class="p">);</span>
                <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span></code></pre></div>

<p>Here we go, our REST API is now ready to roll.</p>

<h2>Evident Patterns</h2>

<p>As we were building our RESTful API, some interesting patterns emerged. For example, the router code block can be swapped with another router code block to add new functionality. In this case, it makes more sense to enclose our routing logic in a separate file. As our code grows, we will also have more schemas, models, and logic to worry about. All of these will eventually need to move out of the server file.</p>

<h2>Refactor Code</h2>

<p>There are hundreds of ways to improve our code. For demonstration, we will move the routing logic out of the server.js.</p>

<p>First, create a new file called router.js. In that file, create a function named registerRoutes that takes in the Express app and Mongoose as parameters. Then, move all the routing logic from server.js to the newly created function. The contents of router.js will be something like this:</p>

<div class="highlight"><pre><code class="js"><span class="kd">function</span> <span class="nx">registerRoutes</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">mongoose</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//Router</span>
    <span class="c1">//Get a list of all books</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;/api/books&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">BookModel</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">books</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span> <span class="nx">books</span> <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span> <span class="p">);</span>
                <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
    
    <span class="c1">//...</span>

    <span class="c1">//Delete a book</span>
    <span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span> <span class="s1">&#39;/api/books/:id&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">BookModel</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span> <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">book</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">book</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s1">&#39;Book removed&#39;</span> <span class="p">);</span>
                    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span> <span class="s1">&#39;&#39;</span> <span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span> <span class="p">);</span>
                    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></div>

<p>The last step is to register the routes from server.js. All you have to do is require your router and call the registerRoutes method in place of your old router.</p>

<h2>Next Steps</h2>

<p>Congratulations! You did it. You built a RESTful API. However, having the API is only one step of the journey. The more important lesson that you need to learn is to take your journey one step at a time. First, create a dumb app. Then, make it smarter. Then, refactor. The cycle goes on and on. The moral of this lesson is that refactoring is a crucial step in software development. Just like you cannot build a skyscraper with a shaky fundamental, you cannot build web applications with bad code. Farewell and good luck on your journey.</p>
</div>
	
    	<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'shamadeh'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  	
</div>


            </div>
            
          </div>
          
            <div id="endpage-box" class="endpage-box"></div>
            <script>
              var related_posts = [{}
                
                  , {
                    title: "How Agile Changed the Software Workplace",
                    date: "06 Sep 2014",
                    url: "/blog/programming/2014/09/06/AgileAndSoftwareDevelopers.html"
                  }
                
                  , {
                    title: "CULC on a Wednesday Morning",
                    date: "20 Aug 2014",
                    url: "/blog/life/2014/08/20/CULCOnAWednesdayMorning.html"
                  }
                
                  , {
                    title: "Back to Tech",
                    date: "18 Aug 2014",
                    url: "/blog/life/2014/08/18/BackToTech.html"
                  }
                
                  , {
                    title: "How to verify phone numbers using Twilio and Parse",
                    date: "31 Jul 2014",
                    url: "/blog/web/mobile/twilio/parse/2014/07/31/VerifyPhoneNumbersTwilioAndParse.html"
                  }
                
                  , {
                    title: "How to host multiple websites using Express.js",
                    date: "20 Jul 2014",
                    url: "/blog/web/nodejs/express/2014/07/20/ExpressMultipleSites.html"
                  }
                
                  , {
                    title: "My Internship at BrainJocks",
                    date: "28 May 2014",
                    url: "/blog/life/2014/05/28/InterningAtBrainJocks.html"
                  }
                
                  , {
                    title: "Web Security: Unvalidated Redirects",
                    date: "06 Apr 2014",
                    url: "/blog/web/2014/04/06/Unvalidated-Redirects.html"
                  }
                
                  , {
                    title: "Assess your Collaborative Programming Skills",
                    date: "16 Mar 2014",
                    url: "/blog/programming/2014/03/16/AssessYourCollaborativeProgramming.html"
                  }
                
                  , {
                    title: "Web Performance Trends: One Load, That's All",
                    date: "24 Feb 2014",
                    url: "/blog/web/2014/02/24/WebPerformanceTrends.html"
                  }
                
                  , {
                    title: "Why You should have a Virtual Machine in the Cloud",
                    date: "09 Feb 2014",
                    url: "/blog/opinion/2014/02/09/WhyYouShouldHaveACloudVM.html"
                  }
                
              ];  //The first blank element is a hack to fix liquid's for loop comma problem

              var post_index = function (min, max) {
                  return Math.floor(Math.random() * (max - min + 1)) + min;
              }(1, related_posts.length); //Get a random integer between 1 and related_posts.length
              $("#endpage-box").html('Related Post<br /><a href="' + related_posts[post_index].url + '">' + related_posts[post_index].title + '</a>');
            </script>
          
        </div>

        <div id="footer">
  <div class="container">
    <p class="text-center">Proudly hosted by Github Pages</p>
  </div>
</div>

        <script src="/bootstrap/js/bootstrap.min.js"></script>

        

        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-46641204-1']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script>
      </div>
    </body>
</html>
